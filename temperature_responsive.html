
<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Predicción Temperatura</title>
<script src="https://d3js.org/d3.v7.min.js"></script>

<style>
    body {
        margin: 0;
        padding: 0;
        background: #0b0f1a;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        color: #e0e0e0;
        overflow: hidden; /* Evita scrollbar en el iframe */
    }

    #chart-wrapper {
        width: 100vw;
        height: 100vh; /* Ocupa toda la altura disponible */
        position: relative;
        display: flex;
        flex-direction: column;
    }

    /* El contenedor del SVG se ajustará */
    #chart-container {
        flex: 1;
        width: 100%;
        min-height: 300px;
        position: relative;
    }

    /* Estilos SVG */
    .axis text { fill: #9aa4ad; font-size: 11px; }
    .axis path, .axis line { stroke: #2a2f45; }
    
    /* Tooltip */
    .tooltip {
        position: absolute;
        background: rgba(17, 24, 39, 0.95);
        border: 1px solid #374151;
        border-radius: 6px;
        padding: 8px 12px;
        font-size: 12px;
        color: #f3f4f6;
        pointer-events: none;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.5);
        opacity: 0;
        transition: opacity 0.1s;
        z-index: 999;
    }
    .tooltip .row { display: flex; justify-content: space-between; gap: 15px; margin-bottom: 2px; }
    .tooltip .title { font-weight: bold; border-bottom: 1px solid #444; margin-bottom: 5px; padding-bottom: 2px; color: #90caf9; }

</style>
</head>
<body>

<div id="chart-wrapper">
    <div id="chart-container"></div>
</div>
<div id="tooltip" class="tooltip"></div>

<script>
    const data = {"time": ["2025-12-28T10:00:00+01:00", "2025-12-28T11:00:00+01:00", "2025-12-28T12:00:00+01:00", "2025-12-28T13:00:00+01:00", "2025-12-28T14:00:00+01:00", "2025-12-28T15:00:00+01:00", "2025-12-28T16:00:00+01:00", "2025-12-28T17:00:00+01:00", "2025-12-28T18:00:00+01:00", "2025-12-28T19:00:00+01:00", "2025-12-28T20:00:00+01:00", "2025-12-28T21:00:00+01:00", "2025-12-28T22:00:00+01:00", "2025-12-28T23:00:00+01:00", "2025-12-29T00:00:00+01:00", "2025-12-29T01:00:00+01:00", "2025-12-29T02:00:00+01:00", "2025-12-29T03:00:00+01:00", "2025-12-29T04:00:00+01:00", "2025-12-29T05:00:00+01:00", "2025-12-29T06:00:00+01:00", "2025-12-29T07:00:00+01:00", "2025-12-29T08:00:00+01:00", "2025-12-29T09:00:00+01:00", "2025-12-29T10:00:00+01:00", "2025-12-29T11:00:00+01:00", "2025-12-29T12:00:00+01:00", "2025-12-29T13:00:00+01:00", "2025-12-29T14:00:00+01:00", "2025-12-29T15:00:00+01:00", "2025-12-29T16:00:00+01:00", "2025-12-29T17:00:00+01:00", "2025-12-29T18:00:00+01:00", "2025-12-29T19:00:00+01:00", "2025-12-29T20:00:00+01:00", "2025-12-29T21:00:00+01:00", "2025-12-29T22:00:00+01:00", "2025-12-29T23:00:00+01:00", "2025-12-30T00:00:00+01:00", "2025-12-30T01:00:00+01:00", "2025-12-30T02:00:00+01:00", "2025-12-30T03:00:00+01:00", "2025-12-30T04:00:00+01:00", "2025-12-30T05:00:00+01:00", "2025-12-30T06:00:00+01:00", "2025-12-30T07:00:00+01:00", "2025-12-30T08:00:00+01:00", "2025-12-30T09:00:00+01:00", "2025-12-30T10:00:00+01:00", "2025-12-30T11:00:00+01:00", "2025-12-30T12:00:00+01:00", "2025-12-30T13:00:00+01:00"], "ensemble": [[5.8, 6.6, 7.5, 9.1, 9.7, 10.4, 10.1, 9.9, 9.7, 9.4, 8.7, 8.1, 7.6, 7.1, 6.6, 6.4, 5.9, 5.6, 5.6, 5.5, 5.1, 5.0, 5.1, 4.9, 5.3, 6.0, 7.1, 8.2, 9.3, 10.2, 10.5, 10.2, 9.4, 8.4, 7.1, 6.5, 6.1, 5.5, 5.0, 4.6, 4.0, 3.2, 3.1, 2.2, 2.4, 2.8, 2.1, 2.2, 2.6, 3.1, 4.0, 4.5], [5.8, 7.0, 7.8, 9.2, 10.0, 11.2, 11.4, 10.1, 9.4, 9.1, 8.2, 7.2, 6.9, 7.2, 6.9, 6.3, 5.9, 5.8, 5.4, 4.9, 4.5, 4.7, 4.9, 4.9, 5.2, 5.8, 6.9, 7.9, 9.2, 9.9, 10.3, 10.4, 9.5, 8.7, 7.6, 6.7, 6.6, 6.3, 4.8, 4.6, 4.4, 4.1, 3.6, 3.3, 3.2, 3.2, 3.4, 3.2, 3.9, 5.5, 6.3, 7.5], [6.0, 7.4, 7.8, 9.3, 10.3, 10.8, 11.7, 11.9, 11.1, 10.5, 9.3, 9.1, 7.5, 7.2, 6.5, 6.1, 5.7, 5.5, 5.2, 4.9, 4.6, 4.1, 4.6, 4.5, 5.1, 6.2, 7.7, 9.1, 10.5, 10.6, 10.8, 10.4, 9.6, 8.8, 7.5, 6.6, 6.2, 5.6, 4.9, 4.4, 3.8, 3.4, 2.7, 2.5, 2.5, 2.0, 2.6, 2.5, 3.5, 4.7, 6.0, 7.4], [5.8, 7.2, 8.8, 9.4, 8.8, 8.6, 9.1, 9.6, 9.2, 8.8, 7.8, 7.2, 6.8, 6.6, 5.9, 5.7, 5.6, 5.2, 5.0, 5.4, 5.5, 4.9, 5.0, 5.3, 5.7, 6.4, 7.1, 7.9, 8.8, 9.7, 10.0, 9.9, 9.2, 7.9, 6.6, 6.1, 5.9, 5.6, 5.4, 5.0, 4.0, 3.4, 2.9, 2.7, 1.9, 1.9, 2.5, 2.5, 3.5, 4.6, 5.6, 7.1], [5.8, 6.8, 8.1, 9.2, 9.5, 10.2, 10.5, 10.6, 10.1, 8.2, 8.2, 7.5, 7.1, 6.3, 5.8, 5.5, 5.4, 5.1, 4.8, 4.7, 4.5, 4.3, 4.4, 4.5, 5.0, 5.5, 6.4, 7.4, 8.3, 9.5, 10.1, 10.0, 9.2, 8.5, 7.0, 6.4, 6.1, 5.2, 5.1, 4.6, 3.9, 3.5, 3.2, 2.8, 2.5, 2.3, 3.0, 3.0, 3.9, 4.8, 6.0, 7.2], [5.7, 6.6, 7.3, 8.5, 9.3, 10.5, 10.8, 10.5, 10.0, 9.9, 9.5, 7.9, 7.1, 6.3, 6.0, 5.5, 5.4, 5.0, 4.9, 4.8, 5.0, 4.9, 5.5, 5.5, 5.9, 6.7, 7.6, 8.7, 9.6, 9.9, 9.9, 9.8, 9.1, 8.5, 7.1, 6.3, 5.8, 5.4, 4.9, 4.7, 4.3, 3.7, 3.4, 3.2, 2.8, 2.6, 1.4, 0.3, 1.2, 2.1, 2.7, 3.3], [6.3, 7.2, 7.5, 8.1, 9.6, 10.9, 11.5, 11.7, 10.8, 9.8, 9.5, 8.9, 7.6, 7.2, 6.7, 6.4, 5.9, 5.7, 5.7, 5.9, 5.9, 5.9, 6.0, 5.5, 5.6, 6.0, 7.0, 8.1, 9.4, 10.0, 10.3, 10.3, 9.6, 8.8, 7.4, 6.7, 5.8, 5.5, 5.4, 5.1, 4.9, 3.8, 3.4, 3.1, 2.6, 2.4, 2.9, 2.8, 3.9, 5.2, 6.7, 8.2], [5.5, 6.2, 7.2, 7.3, 7.8, 9.2, 10.0, 9.9, 9.5, 8.9, 8.0, 7.3, 6.5, 6.1, 6.0, 5.7, 5.4, 5.6, 5.6, 5.4, 5.0, 4.9, 5.5, 5.5, 5.9, 6.2, 7.1, 7.9, 8.6, 9.1, 8.7, 8.4, 8.1, 7.2, 5.6, 4.9, 4.6, 4.3, 4.2, 4.4, 4.4, 3.9, 3.6, 3.0, 2.4, 2.2, 3.3, 2.8, 3.3, 4.2, 4.1, 5.1], [5.9, 6.7, 7.3, 8.6, 9.3, 9.3, 9.7, 9.6, 8.8, 8.6, 7.6, 7.1, 6.6, 6.5, 6.1, 5.7, 5.6, 5.6, 5.4, 5.3, 4.9, 4.7, 4.5, 4.3, 4.8, 5.8, 7.0, 8.2, 9.6, 10.4, 10.3, 9.8, 9.0, 8.3, 6.5, 5.5, 4.9, 4.6, 4.3, 3.7, 3.0, 2.2, 2.2, 2.8, 2.7, 2.3, 2.5, 2.9, 3.3, 4.0, 4.7, 4.9], [5.8, 5.9, 7.0, 8.6, 9.8, 8.9, 9.9, 10.1, 9.3, 7.8, 6.9, 6.4, 6.1, 6.1, 5.7, 5.6, 5.3, 5.1, 5.3, 5.2, 4.9, 4.3, 4.6, 4.3, 4.9, 5.7, 6.8, 8.1, 9.2, 10.3, 10.7, 10.5, 9.6, 8.8, 7.1, 6.4, 5.8, 5.4, 4.8, 4.3, 4.0, 3.6, 3.1, 2.7, 2.3, 2.4, 2.6, 2.4, 2.7, 3.7, 4.5, 5.0], [5.9, 7.5, 8.4, 9.5, 10.5, 10.9, 10.6, 10.9, 10.2, 9.3, 8.2, 7.4, 6.6, 5.9, 5.3, 5.0, 4.4, 4.9, 5.0, 5.0, 5.0, 5.1, 5.4, 5.1, 5.5, 5.9, 7.1, 8.3, 9.3, 9.8, 10.1, 10.2, 9.2, 8.5, 7.0, 6.8, 6.7, 5.9, 5.3, 4.0, 4.0, 3.9, 3.5, 3.1, 3.0, 2.9, 3.0, 2.7, 3.7, 4.7, 5.9, 7.4], [5.8, 7.1, 7.8, 8.6, 8.8, 9.4, 9.5, 9.5, 9.1, 8.1, 7.2, 6.7, 6.3, 6.0, 5.8, 5.6, 5.3, 5.0, 4.8, 4.8, 4.8, 4.2, 4.3, 4.4, 4.9, 5.3, 5.8, 6.4, 7.1, 8.5, 8.9, 8.9, 8.3, 7.8, 6.7, 5.8, 5.4, 5.7, 5.2, 5.1, 4.8, 3.6, 3.9, 3.8, 3.0, 2.7, 3.0, 3.0, 3.9, 5.0, 6.5, 7.5], [5.7, 6.9, 7.0, 8.4, 9.5, 10.0, 10.3, 9.6, 9.5, 9.6, 8.6, 8.5, 7.6, 6.6, 5.7, 5.4, 5.7, 5.5, 5.3, 4.7, 4.5, 4.2, 4.1, 3.9, 4.6, 5.4, 6.7, 8.1, 9.2, 9.8, 10.2, 10.4, 9.5, 8.7, 7.4, 6.5, 5.8, 5.5, 5.1, 4.9, 4.2, 3.8, 3.6, 3.1, 2.8, 2.7, 3.1, 2.8, 3.7, 4.8, 5.9, 6.9], [6.3, 7.1, 8.5, 9.5, 10.3, 10.0, 9.9, 10.6, 10.2, 9.7, 8.5, 8.2, 7.6, 6.7, 6.3, 6.2, 6.1, 5.6, 4.9, 4.5, 4.1, 3.8, 3.9, 3.8, 4.6, 5.4, 6.6, 8.1, 9.6, 10.6, 11.0, 11.1, 10.1, 9.2, 8.0, 7.4, 6.9, 6.5, 5.7, 5.5, 4.1, 4.0, 3.3, 3.0, 2.7, 2.2, 2.6, 2.6, 3.9, 5.1, 6.3, 7.6], [5.5, 5.7, 7.2, 8.5, 8.9, 9.3, 9.8, 9.6, 9.6, 9.3, 8.3, 7.0, 6.9, 6.6, 6.0, 5.3, 5.2, 5.0, 4.9, 4.8, 4.8, 5.1, 5.3, 5.2, 5.4, 6.1, 6.6, 7.7, 8.8, 9.6, 9.7, 9.6, 9.0, 8.0, 6.4, 6.2, 6.0, 5.2, 4.5, 4.1, 3.7, 3.3, 3.1, 2.2, 1.4, 1.6, 2.2, 2.6, 3.0, 3.2, 3.6, 4.2], [5.8, 6.2, 6.4, 6.7, 7.2, 7.5, 8.0, 8.3, 8.1, 8.0, 7.3, 7.2, 6.7, 6.2, 6.1, 5.7, 5.6, 5.6, 5.3, 5.1, 4.7, 4.4, 4.7, 4.5, 4.9, 5.5, 6.7, 8.1, 9.3, 10.1, 10.5, 10.2, 9.2, 8.4, 7.2, 6.7, 6.2, 5.7, 5.6, 4.3, 4.4, 4.0, 3.4, 3.2, 3.0, 2.7, 2.9, 2.7, 3.4, 3.1, 3.8, 4.4], [5.9, 7.5, 8.6, 9.6, 10.2, 9.8, 9.3, 8.9, 8.6, 8.7, 8.1, 7.8, 7.1, 6.6, 6.0, 5.9, 5.9, 6.0, 5.5, 5.2, 5.1, 4.7, 5.0, 5.0, 5.5, 6.2, 7.3, 8.3, 9.4, 10.2, 10.3, 10.1, 9.6, 8.7, 7.4, 6.7, 6.2, 5.7, 5.3, 4.7, 4.4, 3.6, 3.4, 2.6, 2.1, 2.0, 2.1, 2.5, 3.1, 3.6, 4.3, 4.9], [5.5, 6.4, 7.1, 8.2, 9.1, 10.0, 10.7, 10.9, 10.2, 9.2, 7.8, 6.6, 6.1, 6.0, 5.7, 5.5, 5.2, 5.1, 5.0, 5.0, 5.0, 4.8, 4.6, 4.5, 5.1, 5.9, 7.1, 8.4, 9.5, 9.9, 10.2, 10.1, 9.3, 8.5, 7.6, 6.8, 6.0, 5.2, 4.9, 4.6, 4.7, 4.5, 3.6, 3.5, 3.0, 2.9, 3.6, 3.0, 4.6, 5.3, 6.4, 7.6], [5.7, 6.4, 7.6, 8.4, 8.8, 9.6, 9.7, 9.3, 9.0, 7.9, 7.0, 6.8, 6.1, 5.8, 5.5, 5.4, 5.3, 5.3, 5.0, 4.7, 4.5, 4.0, 4.2, 4.2, 5.1, 5.8, 7.0, 8.2, 9.2, 10.0, 10.5, 10.5, 9.7, 8.5, 7.0, 6.9, 6.5, 6.3, 5.6, 5.0, 4.6, 4.1, 3.5, 3.0, 2.5, 2.1, 2.1, 1.8, 2.1, 2.6, 3.2, 3.7], [6.1, 7.3, 7.9, 8.9, 9.4, 10.1, 10.4, 10.0, 9.1, 9.4, 8.6, 7.7, 7.4, 7.0, 6.4, 6.0, 5.8, 5.8, 5.7, 5.4, 5.5, 5.2, 5.3, 5.0, 6.0, 7.1, 8.1, 8.8, 9.0, 9.7, 9.9, 9.9, 9.3, 8.3, 7.0, 6.3, 6.0, 5.7, 5.5, 5.2, 4.9, 3.8, 3.2, 3.0, 2.6, 2.4, 3.0, 3.0, 3.7, 4.8, 5.8, 7.1], [6.2, 7.4, 7.9, 9.5, 10.0, 8.8, 9.1, 8.9, 8.5, 7.8, 7.1, 6.9, 6.6, 6.3, 5.8, 5.4, 5.2, 4.9, 5.2, 5.2, 5.0, 4.8, 5.0, 5.0, 5.1, 5.3, 5.9, 7.0, 8.5, 9.4, 9.7, 9.6, 9.0, 8.4, 6.8, 6.0, 5.6, 5.2, 5.3, 4.4, 3.8, 3.7, 3.3, 3.0, 2.7, 1.8, 1.4, 0.6, 1.4, 2.2, 3.3, 4.7], [5.6, 7.3, 8.1, 8.8, 10.0, 10.9, 11.2, 11.2, 10.9, 10.3, 9.4, 8.7, 7.3, 6.6, 6.4, 5.9, 5.6, 5.6, 5.3, 5.2, 5.3, 4.9, 4.7, 4.5, 4.8, 5.7, 7.2, 8.7, 9.8, 10.5, 10.8, 10.7, 9.8, 9.1, 7.6, 6.8, 6.1, 5.8, 5.4, 4.5, 3.9, 3.6, 3.1, 2.8, 2.6, 2.4, 2.7, 2.6, 3.6, 4.9, 5.7, 6.2], [5.9, 6.8, 7.4, 8.1, 10.0, 11.1, 11.5, 11.9, 9.9, 9.6, 8.6, 8.0, 7.4, 6.8, 6.7, 6.1, 6.0, 5.8, 5.7, 5.4, 4.9, 4.6, 5.0, 4.9, 5.5, 6.4, 7.7, 8.9, 9.9, 10.5, 10.7, 10.7, 9.9, 9.0, 7.7, 6.9, 6.6, 6.3, 5.5, 4.8, 4.8, 4.6, 4.0, 3.6, 3.4, 3.0, 3.3, 3.5, 4.2, 5.4, 6.5, 7.9], [5.8, 6.3, 7.7, 9.0, 9.4, 8.8, 8.9, 8.8, 8.4, 7.8, 7.3, 7.1, 6.9, 6.3, 5.9, 5.7, 5.5, 5.2, 4.9, 4.5, 4.9, 4.9, 5.5, 5.6, 5.5, 5.9, 6.2, 6.9, 8.2, 9.4, 9.8, 9.8, 9.0, 8.3, 6.7, 6.1, 5.4, 4.8, 4.4, 4.2, 4.0, 3.6, 3.3, 2.8, 2.4, 2.0, 2.7, 2.8, 3.6, 4.5, 5.8, 6.7]], "ctrl": [5.7, 6.8, 8.0, 9.0, 10.0, 10.6, 10.8, 10.6, 9.9, 9.6, 8.2, 7.5, 6.7, 6.2, 6.3, 6.0, 5.8, 5.3, 5.1, 5.3, 5.4, 5.3, 5.2, 5.1, 5.2, 5.9, 7.0, 8.2, 9.6, 10.2, 10.2, 10.3, 9.7, 8.8, 7.5, 6.8, 6.3, 6.0, 5.7, 4.3, 4.4, 3.8, 3.5, 3.3, 2.9, 2.7, 3.1, 2.9, 3.8, 4.9, 6.2, 7.6], "actual": [6.2, 7.5, 8.2, 9.1, 10.2, 11.1, 11.0, 10.3, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN], "daily_extremes": [{"date": "2025-12-28T00:00:00", "tmin": 5.5, "tmax": 11.9, "tmin_time": "2025-12-28T10:00:00+01:00", "tmax_time": "2025-12-28T17:00:00+01:00"}, {"date": "2025-12-29T00:00:00", "tmin": 3.8, "tmax": 11.1, "tmin_time": "2025-12-29T07:00:00+01:00", "tmax_time": "2025-12-29T17:00:00+01:00"}, {"date": "2025-12-30T00:00:00", "tmin": 0.3, "tmax": 8.2, "tmin_time": "2025-12-30T09:00:00+01:00", "tmax_time": "2025-12-30T13:00:00+01:00"}], "climatology": {"tmax": {"upper": 11.168000000000001, "lower": 7.7}, "tmin": {"upper": 5.1583333333333306, "lower": 1.0776666666666666}}};
    const container = d3.select("#chart-container");
    const tooltip = d3.select("#tooltip");
    
    // Parsear fechas
    const time = data.time.map(d3.isoParse);

    function render() {
        // Limpiar
        container.selectAll("*").remove();

        // Obtener dimensiones reales del contenedor
        const rect = container.node().getBoundingClientRect();
        const width = rect.width;
        const height = rect.height;

        // Si es muy pequeño (ej. carga inicial), no renderizar o usar mínimos
        if (width === 0 || height === 0) return;

        const isMobile = width < 600;
        const margin = { top: 20, right: isMobile ? 15 : 40, bottom: 30, left: isMobile ? 35 : 50 };
        const innerWidth = width - margin.left - margin.right;
        const innerHeight = height - margin.top - margin.bottom;

        const svg = container.append("svg")
            .attr("width", width)
            .attr("height", height);

        const g = svg.append("g")
            .attr("transform", `translate(${margin.left},${margin.top})`);

        // --- ESCALAS ---
        const x = d3.scaleTime().domain(d3.extent(time)).range([0, innerWidth]);

        // Aseguramos que las bandas de climatología entren en el dominio Y
        const allValues = [
            ...data.ctrl,
            ...data.ensemble.flat(),
            data.climatology.tmax.upper,
            data.climatology.tmax.lower,
            data.climatology.tmin.upper,
            data.climatology.tmin.lower
        ];
        if (data.actual) {
            data.actual.forEach(d => { if(d !== null) allValues.push(d); });
        }

        const y = d3.scaleLinear()
            .domain([d3.min(allValues) - 2, d3.max(allValues) + 2])
            .range([innerHeight, 0]);

        // --- DIBUJO ---

        // 1. Climatología (Áreas Rectangulares)
        // Maximas (Rojo)
        g.append("rect")
            .attr("x", 0)
            .attr("width", innerWidth)
            .attr("y", y(data.climatology.tmax.upper))
            .attr("height", Math.abs(y(data.climatology.tmax.lower) - y(data.climatology.tmax.upper)))
            .attr("fill", "#ef5350")
            .attr("opacity", 0.25); // Opacidad aumentada

        // Minimas (Azul)
        g.append("rect")
            .attr("x", 0)
            .attr("width", innerWidth)
            .attr("y", y(data.climatology.tmin.upper))
            .attr("height", Math.abs(y(data.climatology.tmin.lower) - y(data.climatology.tmin.upper)))
            .attr("fill", "#42a5f5")
            .attr("opacity", 0.25); // Opacidad aumentada

        const line = d3.line()
            .defined(d => d !== null)
            .x((d, i) => x(time[i]))
            .y(d => y(d));

        // 2. Ensemble
        g.selectAll(".ens")
            .data(data.ensemble)
            .enter().append("path")
            .attr("fill", "none")
            .attr("stroke", "#90caf9")
            .attr("stroke-width", 1)
            .attr("stroke-opacity", 0.3)
            .attr("d", d => line(d));

        // 3. Control
        g.append("path")
            .datum(data.ctrl)
            .attr("fill", "none")
            .attr("stroke", "#ffffff")
            .attr("stroke-width", 2.5)
            .attr("d", line);

        // 4. Actual
        g.append("path")
            .datum(data.actual)
            .attr("fill", "none")
            .attr("stroke", "#00e676")
            .attr("stroke-width", 2.5)
            .attr("d", line);

        // 5. Textos de extremos (Solo si hay espacio)
        if (!isMobile || innerWidth > 350) {
            data.daily_extremes.forEach(d => {
                g.append("text")
                    .attr("x", x(new Date(d.tmax_time)))
                    .attr("y", y(d.tmax) - 6)
                    .attr("text-anchor", "middle")
                    .attr("fill", "#ef5350")
                    .attr("font-weight", "bold")
                    .attr("font-size", "10px")
                    .text(d.tmax.toFixed(1));
                
                g.append("text")
                    .attr("x", x(new Date(d.tmin_time)))
                    .attr("y", y(d.tmin) + 12)
                    .attr("text-anchor", "middle")
                    .attr("fill", "#42a5f5")
                    .attr("font-weight", "bold")
                    .attr("font-size", "10px")
                    .text(d.tmin.toFixed(1));
            });
        }

        // --- EJES ---
        g.append("g")
            .attr("class", "axis")
            .attr("transform", `translate(0,${innerHeight})`)
            .call(d3.axisBottom(x).ticks(isMobile ? 4 : 8).tickFormat(d3.timeFormat("%d/%m %H:00")));

        g.append("g")
            .attr("class", "axis")
            .call(d3.axisLeft(y));

        // --- INTERACTIVIDAD (Mouse + Touch) ---
        const bisect = d3.bisector(d => d).left;
        
        // Linea vertical
        const focusLine = g.append("line")
            .attr("stroke", "#fff")
            .attr("stroke-dasharray", "4")
            .attr("y1", 0).attr("y2", innerHeight)
            .attr("opacity", 0);

        // Rectángulo transparente encima para capturar eventos
        g.append("rect")
            .attr("width", innerWidth)
            .attr("height", innerHeight)
            .attr("fill", "transparent")
            .on("mousemove touchmove", function(event) {
                event.preventDefault(); // Evitar scroll en móvil al tocar el gráfico
                
                // Obtener coordenadas (funciona para touch y mouse)
                let clientX;
                if(event.type === 'touchmove') {
                    clientX = event.touches[0].clientX;
                    // Ajustar offset del SVG
                    const bounds = this.getBoundingClientRect();
                    clientX = clientX - bounds.left; 
                } else {
                    clientX = d3.pointer(event)[0];
                }

                const dateVal = x.invert(clientX);
                const i = bisect(time, dateVal);
                const idx = Math.max(0, Math.min(time.length - 1, i));

                // Actualizar linea
                focusLine.attr("x1", x(time[idx])).attr("x2", x(time[idx])).attr("opacity", 0.5);

                // Estadísticas
                const ensVals = data.ensemble.map(m => m[idx]).sort(d3.ascending);
                const mean = d3.mean(ensVals);
                const p10 = d3.quantile(ensVals, 0.1);
                const p90 = d3.quantile(ensVals, 0.9);

                // Tooltip
                let pageX, pageY;
                if(event.type === 'touchmove') {
                    pageX = event.touches[0].pageX;
                    pageY = event.touches[0].pageY;
                } else {
                    pageX = event.pageX;
                    pageY = event.pageY;
                }

                // Evitar overflow derecha
                const tpNode = tooltip.node();
                let left = pageX + 15;
                if (left + 150 > window.innerWidth) left = pageX - 160;

                tooltip
                    .style("opacity", 1)
                    .style("left", left + "px")
                    .style("top", (pageY + 15) + "px")
                    .html(`
                        <div class="title">${time[idx].toLocaleDateString(undefined, {weekday:'short', day:'numeric', hour:'2-digit'})}</div>
                        <div class="row"><span>Media Ens:</span> <b>${mean.toFixed(1)}°</b></div>
                        <div class="row"><span>Rango 10-90%:</span> <span>${p10.toFixed(1)} - ${p90.toFixed(1)}</span></div>
                        <div class="row"><span>Control:</span> <b>${data.ctrl[idx].toFixed(1)}°</b></div>
                        ${data.actual[idx] !== null ? `<div class="row" style="color:#69f0ae"><span>Actual:</span> <b>${data.actual[idx].toFixed(1)}°</b></div>` : ''}
                    `);

            })
            .on("mouseleave touchend", () => {
                tooltip.style("opacity", 0);
                focusLine.attr("opacity", 0);
            });
    }

    // Render inicial
    render();
    
    // Redibujar al cambiar tamaño (Responsividad)
    window.addEventListener("resize", render);
</script>
</body>
</html>
